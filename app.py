import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime
import time

# --- 1. SETTING & UI STYLE ---
st.set_page_config(page_title="Cloud Drugstore POS", layout="wide")

# --- 2. CONNECT TO GOOGLE SHEETS ---
sheet_url = "https://docs.google.com/spreadsheets/d/1EzHEAUtcA1Bwub0DDg3T02JiGbtnPH4IEEhhSS4oa3k/edit?usp=sharing"
conn = st.connection("gsheets", type=GSheetsConnection)

def get_stock_data():
    try:
        # ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏µ‡∏ï‡∏ä‡∏∑‡πà‡∏≠ stock
        return conn.read(spreadsheet=sheet_url, worksheet="stock", ttl=0)
    except Exception as e:
        st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏µ‡∏ï 'stock' ‡πÑ‡∏î‡πâ: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á Google Sheets")
        return pd.DataFrame()

def get_sales_data():
    try:
        # ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏µ‡∏ï‡∏ä‡∏∑‡πà‡∏≠ ‡∏ä‡∏µ‡∏ï2
        return conn.read(spreadsheet=sheet_url, worksheet="‡∏ä‡∏µ‡∏ï2", ttl=0)
    except Exception as e:
        st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏µ‡∏ï '‡∏ä‡∏µ‡∏ï2' ‡πÑ‡∏î‡πâ: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á Google Sheets")
        return pd.DataFrame()

# --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ ---
df_stock = get_stock_data()

if df_stock.empty:
    st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Google Sheets ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠ 'stock' ‡πÅ‡∏•‡∏∞ '‡∏ä‡∏µ‡∏ï2')")
    st.stop()

# --- NAVIGATION ---
with st.sidebar:
    st.title("üíä PHARMA")
    choice = st.radio("‡πÄ‡∏°‡∏ô‡∏π", ["üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‚ö†Ô∏è ‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î", "üìã ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å", "üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á", "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"])

# --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) ---
if choice == "üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤":
    st.subheader("üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    # (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°...)
    # [‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥: ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏µ‡∏î‡∏≥‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡πà‡∏á‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà]
    st.write("‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    st.dataframe(df_stock)

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á (ID Check ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
elif choice == "üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á":
    st.title("üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    n_id = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏≤ (ID)")
    if n_id:
        # ‡πÄ‡∏ä‡πá‡∏Ñ ID ‡∏ã‡πâ‡∏≥‡πÅ‡∏ö‡∏ö Real-time
        match = df_stock[df_stock['id'].astype(str) == n_id]
        if not match.empty:
            st.error(f"‚ùå ‡∏£‡∏´‡∏±‡∏™ '{n_id}' ‡∏ô‡∏µ‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: **{match.iloc[0]['name']}**")